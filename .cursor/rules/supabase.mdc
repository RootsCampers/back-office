---
description: Supabase integration (Auth & Database)
globs:
  - "lib/supabase.ts"
  - "app/api/**/*.ts"
  - "hooks/**/*.ts"
  - "components/auth/**/*.tsx"
  - "components/profile/**/*.tsx"
  - "utils/**/*.ts"
alwaysApply: false
---

# Supabase

## Summary

Guide for proper Supabase integration in authentication and database queries. All queries must explicitly specify the schema and handle errors consistently.

## Client

The client is in `lib/supabase.ts`:

```ts
import { supabase } from "@/lib/supabase";
```

## Using .schema()

Always specify the schema when necessary:

```ts
// ✅ DO: Explicitly specify schema
const { data, error } = await supabase
  .schema("public")
  .from("campers")
  .select("*");

// For RPC functions in specific schemas
const { data, error } = await supabase
  .schema("pricing")
  .rpc("calculate_trip_price", { camper_id: id });
```

## Basic queries

```ts
// SELECT with schema
const { data, error } = await supabase
  .schema("public")
  .from("campers")
  .select("id, name, images, passengers")
  .eq("status", "active");

// INSERT
const { data, error } = await supabase
  .schema("public")
  .from("bookings")
  .insert({ camper_id: id, user_id: userId });

// UPDATE
const { data, error } = await supabase
  .schema("public")
  .from("campers")
  .update({ status: "inactive" })
  .eq("id", camperId);
```

## Error handling

```ts
// ✅ DO: Always check for errors
const { data, error } = await supabase
  .schema("public")
  .from("campers")
  .select();

if (error) {
  console.error("Error fetching campers:", error);
  throw new Error("Failed to fetch campers");
}
return data;

// ❌ DON'T: Ignore errors
const { data } = await supabase.from("campers").select();
return data; // can be null if there's an error!
```

## Joins and relations

```ts
const { data } = await supabase
  .schema("public")
  .from("campers")
  .select(
    `
    id,
    name,
    owner:profiles!owner_id (
      id,
      full_name,
      avatar_url
    )
  `,
  )
  .eq("id", camperId)
  .single();
```

## Auth in Server Components

```ts
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import { cookies } from "next/headers";

export default async function ProtectedPage() {
  const supabase = createServerComponentClient({ cookies });
  const {
    data: { session },
  } = await supabase.auth.getSession();

  if (!session) redirect("/auth/login");
  // ...
}
```

## Naming conventions

| Element      | Convention        | Example                     |
| ------------ | ----------------- | --------------------------- |
| Schemas      | snake_case        | `public`, `pricing`, `auth` |
| Tables       | snake_case plural | `campers`, `blocked_days`   |
| Columns      | snake_case        | `created_at`, `owner_id`    |
| Foreign keys | `entity_id`       | `camper_id`, `user_id`      |
| Functions    | `verb_noun`       | `get_available_campers`     |

## See also

- [nextjs](mdc:.cursor/rules/nextjs.mdc) for Server Components and API Routes patterns
- [security](mdc:.cursor/rules/security.mdc) for authentication and authorization best practices
- [data-validation](mdc:.cursor/rules/data-validation.mdc) for type validation with Zod and TypeScript
